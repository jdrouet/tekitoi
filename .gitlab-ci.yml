stages:
  - test
  - build

lint-demo:
  stage: test
  image: rust:latest
  only:
    changes:
      - tekitoi-demo/**/*
  before_script:
    - rustup component add clippy
    - rustup component add rustfmt
  script:
    - cd tekitoi-demo
    - cargo fmt --check
    - cargo clippy --tests -- -D warnings

lint-server:
  stage: test
  image: rust:latest
  only:
    changes:
      - tekitoi-server/**/*
  before_script:
    - rustup component add clippy
    - rustup component add rustfmt
  script:
    - cd tekitoi-server
    - cargo fmt --check
    - cargo clippy --tests -- -D warnings

integration:
  stage: test
  image: rust:latest
  only:
    changes:
      - tekitoi-server/**/*
  services:
    - redis:alpine
  variables:
    CACHE__URL: redis://redis
  script:
    - cd tekitoi-server
    - cargo test

image-demo:
  stage: build
  image: jdrouet/docker-with-buildx:latest
  only:
    - main
    - ci-config
  services:
    - docker:dind
  before_script:
    - docker login --username $DOCKER_USERNAME --password $DOCKER_PASSWORD
    - docker buildx create --use --platform linux/amd64,linux/arm64
  script:
    - docker buildx build --platform linux/amd64,linux/arm64 -t jdrouet/tekitoi-demo:canary tekitoi-demo

image-server:
  stage: build
  image: jdrouet/docker-with-buildx:latest
  only:
    - main
    - ci-config
  services:
    - docker:dind
  before_script:
    - docker login --username $DOCKER_USERNAME --password $DOCKER_PASSWORD
    - docker buildx create --use --platform linux/amd64,linux/arm64
  script:
    - docker buildx build --platform linux/amd64,linux/arm64 -t jdrouet/tekitoi:canary tekitoi-demo
